# Securing services with cert-manager

trusted-cluster-operator's components can be secured with TLS certificates.
For production environments, this is strongly recommended.

When TLS authentication is enabled, the operator assumes secrets shaped like the ones issued by [cert-manager](https://cert-manager.io/), i.e. containing a `tls.key`, `tls.crt`, and `ca.crt`.
The latter are only required in the Trustee and AK registration secrets, where register-server uses them to provide certificates for these endpoints.

Updating certificates is **not** yet supported.

## Creating secrets

There should be secrets for Trustee, register-server, and attestation-key-register-server when the latter is used.
When using cert-manager, these secrets are generated by creating `certificaterequest.cert-manager.io` resources.

This guide demonstrates the use of self-signed certificates.
Refer to cert-manager's documentation for further information on PKI setup.

```yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: root-issuer
  namespace: trusted-execution-clusters
spec:
  selfSigned: {}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: root-cert
  namespace: trusted-execution-clusters
spec:
  isCA: true
  commonName: selfsigned-ca
  secretName: root-secret
  issuerRef:
    name: root-issuer
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: my-issuer
  namespace: trusted-execution-clusters
spec:
  ca:
    secretName: root-secret
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: register-server-cert
  namespace: trusted-execution-clusters
spec:
  secretName: reg-srv-secret
  duration: 8760h
  issuerRef:
    name: my-issuer
  dnsNames:
    - register-server.trusted-execution-clusters.svc.cluster.local
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: trustee-cert
  namespace: trusted-execution-clusters
spec:
  secretName: trustee-secret
  duration: 8760h
  issuerRef:
    name: my-issuer
  dnsNames:
    - kbs-service.trusted-execution-clusters.svc.cluster.local
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: attestation-key-register-cert
  namespace: trusted-execution-clusters
spec:
  secretName: ak-reg-secret
  duration: 8760h
  issuerRef:
    name: my-issuer
  dnsNames:
    - attestation-key-register.trusted-execution-clusters.svc.cluster.local
```

## Providing certificates

### To the operator

Give the names of the secrets in the `TrustedExecutionCluster` resource:

```yaml
apiVersion: trusted-execution-clusters.io/v1alpha1
kind: TrustedExecutionCluster
# ...
spec:
  # ...
  registerServerSecret: reg-srv-secret
  trusteeSecret: trustee-secret
  attestationKeyRegisterSecret: ak-reg-secret
```

### To the node

Retrieve the root CA public key, percent-encode it and add it as a certifiate authority to the Ignition given to the node:

```sh
$ kubectl get secret root-secret -n trusted-execution-clusters -o json | jq -r '.data["ca.crt"]' | base64 -d | jq -sRr @uri
-----BEGIN%20CERTIFICATE-----%0AMIIDADCCAeigAwIBAgIUFH9qhi%2BPRf%2B0wDirJF2PcQbP8DowDQYJKoZIhvcNAQEL%0ABQAwGDEWMBQGA1UEAxMNc2VsZnNpZ25lZC1jYTAeFw0yNjAyMjcyMTAzMDdaFw0y%0ANjA1MjgyMTAzMDdaMBgxFjAUBgNVBAMTDXNlbGZzaWduZWQtY2EwggEiMA0GCSqG%0ASIb3DQEBAQUAA4IBDwAwggEKAoIBAQC6icR58Bsbb80Q7Ncjtg5GQed1nO%2BPdxlL%0AmsSnrcSoLNzBSObdJvu0IcZr38S9DKERk9bx3Rfl0Td8HcgFXdDN9UZCT5Op7Yew%0Ae6eGFbe8D6jlMewA7dr6jE1W5HgDyvQTadj4%2BcnLoaNZdALaxt%2FushWX%2FgA9pAcL%0ASB7Eu8%2Bn7%2FxZPoTvPE1Vjzaun0QiXbUxmYAqPouFV4ZWaimo3vbaIpi5Qm2GneS4%0ApxCj5XRZwAwTY09jM%2FuF1pK0vwNS8Q2IVXDrLTDKMZ7Y6gw2m39%2F4XvFZaiLQG4C%0A%2B42vIAcWv%2Fud%2Bmh%2FfNuKqJNI%2FQoCLaFUpG5%2BYkzvwgYd15nH%2FbwpAgMBAAGjQjBA%0AMA4GA1UdDwEB%2FwQEAwICpDAPBgNVHRMBAf8EBTADAQH%2FMB0GA1UdDgQWBBQUsYg%2F%0A3UjNzaSFVmYCwAIA70YOSzANBgkqhkiG9w0BAQsFAAOCAQEAs6fTeBlNlAuoFql9%0AVZDrmocGs9WmaplENOIhBnmoVmNr1YDBukN54rxF2jcEXTu%2Bv06dMSZoXfwimM8l%0A4It6ZJy8LauGu1u9aj0wlGnOvFQD85u%2BK8T9DycMJSSd6wj5yy7XNvteN8RjgR7K%0A%2FdIOZ6Em0wUB2KkhHPDNd%2BY5DoGVdryo%2FEMJFMeXgrM1AXXJIlSCH6YgFuT8ctWJ%0AOHFm0sWsX9YP5dXQDHfXh4CdNVnPiIVumoj3%2FCSdYRZ9JvB0AjEUSAtqqaChmjBZ%0Aj5OMPXQriYuMg6r3i28ivHfuW8g8l0mr88JN75Wqo%2FHcWAbHG8DVBxPIkqzuKP%2BP%0AMEQwpw%3D%3D%0A-----END%20CERTIFICATE-----%0A

```json
{
  "ignition": {
    "config": {
      "security": {
        "tls": {
          "certificateAuthorities": [
            {
              "source": "data:,-----BEGIN%20CERTIFICATE-----%0AMIIDADCCAeigAwIBAgIUFH9qhi%2BPRf%2B0wDirJF2PcQbP8DowDQYJKoZIhvcNAQEL%0ABQAwGDEWMBQGA1UEAxMNc2VsZnNpZ25lZC1jYTAeFw0yNjAyMjcyMTAzMDdaFw0y%0ANjA1MjgyMTAzMDdaMBgxFjAUBgNVBAMTDXNlbGZzaWduZWQtY2EwggEiMA0GCSqG%0ASIb3DQEBAQUAA4IBDwAwggEKAoIBAQC6icR58Bsbb80Q7Ncjtg5GQed1nO%2BPdxlL%0AmsSnrcSoLNzBSObdJvu0IcZr38S9DKERk9bx3Rfl0Td8HcgFXdDN9UZCT5Op7Yew%0Ae6eGFbe8D6jlMewA7dr6jE1W5HgDyvQTadj4%2BcnLoaNZdALaxt%2FushWX%2FgA9pAcL%0ASB7Eu8%2Bn7%2FxZPoTvPE1Vjzaun0QiXbUxmYAqPouFV4ZWaimo3vbaIpi5Qm2GneS4%0ApxCj5XRZwAwTY09jM%2FuF1pK0vwNS8Q2IVXDrLTDKMZ7Y6gw2m39%2F4XvFZaiLQG4C%0A%2B42vIAcWv%2Fud%2Bmh%2FfNuKqJNI%2FQoCLaFUpG5%2BYkzvwgYd15nH%2FbwpAgMBAAGjQjBA%0AMA4GA1UdDwEB%2FwQEAwICpDAPBgNVHRMBAf8EBTADAQH%2FMB0GA1UdDgQWBBQUsYg%2F%0A3UjNzaSFVmYCwAIA70YOSzANBgkqhkiG9w0BAQsFAAOCAQEAs6fTeBlNlAuoFql9%0AVZDrmocGs9WmaplENOIhBnmoVmNr1YDBukN54rxF2jcEXTu%2Bv06dMSZoXfwimM8l%0A4It6ZJy8LauGu1u9aj0wlGnOvFQD85u%2BK8T9DycMJSSd6wj5yy7XNvteN8RjgR7K%0A%2FdIOZ6Em0wUB2KkhHPDNd%2BY5DoGVdryo%2FEMJFMeXgrM1AXXJIlSCH6YgFuT8ctWJ%0AOHFm0sWsX9YP5dXQDHfXh4CdNVnPiIVumoj3%2FCSdYRZ9JvB0AjEUSAtqqaChmjBZ%0Aj5OMPXQriYuMg6r3i28ivHfuW8g8l0mr88JN75Wqo%2FHcWAbHG8DVBxPIkqzuKP%2BP%0AMEQwpw%3D%3D%0A-----END%20CERTIFICATE-----%0A"
            },
			…
          ]
        }
      }
    },
    …
  },
  …
}
```
